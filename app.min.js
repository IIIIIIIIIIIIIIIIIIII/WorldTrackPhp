var myApp = angular.module("worldTracker", ["ui.bootstrap"]); myApp.directive("chart", function () { var e = 600; var t = 400; return { restrict: "E", template: "<canvas></canvas>", scope: { chartObject: "=value" }, link: function (n, r, i) { var s = r.find("canvas")[0], o = s.getContext("2d"), u; var a = { animation: false, width: i.width || e, height: i.height || t }; s.width = a.width; s.height = a.height; u = (new Chart(o)).Line(n.chartObject, a); n.$watch(function () { return n.chartObject }, function (e) { debugger; if (!e) return; u.destroy(); u = (new Chart(o)).Line(n.chartObject, a) }) } } }); myApp.filter("reverse", function () { return function (e) { return e.slice().reverse() } }); myApp.factory("WorldTrackHelper", function () { return { getIncreaseModel: function (e, t) { e.sort(function (e, t) { if (e.change < t.change) return 1; if (e.change > t.change) return -1; return 0 }); var n = []; for (var r = 0; r < 5; r++) { n.push({ id: e[r].id, name: e[r].name, change: e[r].change }) } return { date: t, changes: n } }, findObjectById: function (e, t) { for (var n = 0; n < t.length; n++) { var r = t[n]; if (r.id === e) { return r } } } } }); myApp.controller("WorldTrackCtrl", ["$scope", "$rootScope", "$timeout", "$modal", "WorldTrackHelper", function (e, t, n, r, i) { e.tracking = false; var s = []; var o = []; var u = false; var a; e.latestChanges = []; var f = function () { if (e.tracking) { $.get("http://crossorigin.me/http://oldschool.runescape.com/serverlist.csv?order=WMLPA", function (r) { var l = s.length < 1; var c = new Date; r = r.replace("FULL", "2000"); var h = r.split("\n"); for (var p = 0; p < h.length - 1; p++) { var d = h[p].split(","); if (l) { s.push({ id: d[0], name: d[1], population: d[2], change: 0, history: [{ date: c, population: d[2] }] }) } else { var v; for (var m = 0; m < s.length; m++) { if (s[m].id === d[0]) { v = s[m]; continue } } var g = v.population; var y = d[2]; v.change = y - g; v.population = y; v.history.push({ date: c, population: y }) } } if (!l) { if (o.length === 5) { o.shift() } var b = i.getIncreaseModel(s, c); o.push(b); e.latestChanges = o; e.$apply() } if (u) { var w = i.findObjectById(a, s); t.$broadcast("worldUpdate", w.history[w.history.length - 1]) } n(f, 15e3) }) } }; e.showHistory = function (e) { u = true; a = e; var t = i.findObjectById(e, s); var n = r.open({ templateUrl: "world-history.html", controller: "WorldHistoryCtrl", resolve: { world: function () { return t } } }); n.result.then(function () { u = false }, function () { u = false }) }; e.start = function () { s = []; e.tracking = true; f() }; e.stop = function () { e.tracking = false; e.lastFiveChanges = [] } }]); myApp.controller("WorldHistoryCtrl", ["$scope", "$modalInstance", "$filter", "world", function (e, t, n, r) { var i = function (e, t) { return { labels: e, datasets: [{ label: r.name + " Population History", fillColor: "rgba(220,220,220,0.2)", strokeColor: "rgba(220,220,220,1)", pointColor: "rgba(220,220,220,1)", pointStrokeColor: "#fff", pointHighlightFill: "#fff", pointHighlightStroke: "rgba(220,220,220,1)", data: t }] } }; var s = []; var o = []; var u; if (r.history.length < 8) { u = 0 } else { u = r.history.length - 8 } for (var a = u; a < r.history.length; a++) { var f = n("date")(r.history[a].date, "H:mm:ss"); s.push(f); o.push(r.history[a].population) } e.$on("worldUpdate", function (t, r) { var u = n("date")(r.date, "H:mm:ss"); if (s.length > 7) { s.shift(); o.shift() } s.push(u); o.push(r.population); e.worldData = i(s, o); e.$apply() }); e.world = r; e.worldData = i(s, o); e.close = function () { t.close("close") } }])
